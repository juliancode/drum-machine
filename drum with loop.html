<html>
<head>
  <title>web audio api</title>
  <!-- 
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  Local Version for Offline Development -->
  <script src="jquery.js"></script>
  <style>
    body {
      background: #222;
    }

    .container {
      width: 100%;
      display: flex;
    }

    .controls {
      width: 50%;
    }

    .drummachine {
      width: 50%;
      display: flex;
      flex-flow: wrap row;
    }

    button { 
      width: 8rem;
      height: 8rem;
      padding: 4rem;
      background: #666;
      border: 2px solid black;
      color: #ddd;
      font-size: 2rem;
      transition: background-color 0.25s ease-in-out;
    }
    .drum {
      width: 33%;
      height: 33%;
    }
    .active {
      background: red;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="controls">
    <p>Controls go here</p>
  </div>
  <div class="drummachine">
    <button class="kick drum">Kick</button>
    <button class="snare drum">High Snare</button>
    <button class="hat drum">Hat</button>
    <button class="wooden drum">Cowbell</button>
    <button class="metal drum">Shaker</button>
    <button class="snare1 drum">Low Snare</button>
    <button class="ride drum">Ride</button>
    <button class="bass drum">Bass Stab</button>
    <button class="lead drum">Lead Stab</button>

  </div>
</div>


<script>
// define variables

// var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

(function() {
  // var kickSample = undefined
  var kickButton = $('.kick');
  var snareButton = $('.snare');
  var hatButton = $('.hat');
  var woodenButton = $('.wooden');
  var metalButton = $('.metal');
  var snare1Button = $('.snare1');
  var rideButton = $('.ride');
  var bassButton = $('.bass');
  var leadButton = $('.lead');




  var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  Sample = function(filename) {
    var request = new XMLHttpRequest();
    request.open('GET', filename, true);
    request.responseType = 'arraybuffer';
    var sampleBuffer;
    var isPlaying = false;

    this.drumName = filename.split(".")[0]

    this.tempo = 172
    var oneBeatTime = (60 / this.tempo)
    var oneBarTime = oneBeatTime * 4
    var numberOfBars = 8
    var totalLoop = oneBarTime * numberOfBars
    
    request.onload = function() {
      var audioData = request.response; 

      audioCtx.decodeAudioData(
        audioData, 
        function(buffer) {
          sampleBuffer = buffer;
        }, 
        function(e){"Error with decoding audio data" + e.err}
      );
    }
    request.send();
 
    this.play = function() {
      if (isPlaying === false) {
        var sample = audioCtx.createBufferSource()
        sample.buffer = sampleBuffer;
        sample.connect(audioCtx.destination);
        sample.loop = this.loop;
        sample.start(0);
      }
      isPlaying = true
    }

    this.playInNumberOfSeconds = function(numberOfSeconds) {
      var sample = audioCtx.createBufferSource()
      sample.buffer = sampleBuffer;
      sample.connect(audioCtx.destination);
      sample.loop = this.loop;
      if (!sample.start)
        sample.start = sample.noteOn;
      sample.start(numberOfSeconds);
    }

    this.stop = function() {
      isPlaying = false
    }

    this.playLoop = function(step) {
      var startTime = audioCtx.currentTime;
      var time = startTime + (step * oneBeatTime);

      this.playInNumberOfSeconds(time);

    }
  }

        // Play the snare drum on beats 3, 7
        // playSound(snare, time + 2 * oneBeatTime);
        // playSound(snare, time + 6 * oneBeatTime);

        // // Play the hi-hat every eighth note.
        // for (var i = 0; i < 8; ++i) {
        //   his.playOnceInNumberOfSeconds()
        //   playSound(hihat, time + i * oneBeatTime);
        // }


  var kick = new Sample("kick.wav")
  var snare = new Sample("snare.wav")
  var hat = new Sample("hat.wav")
  var wooden = new Sample("wooden.wav")
  var metal = new Sample("metal.wav")
  var snare1 = new Sample("snare1.wav")
  var ride = new Sample("ride.wav")
  var bass = new Sample("bass_stab.wav")
  var lead = new Sample("lead_stab.wav")


  $("body").click(function() {
    kick.playLoop(0)
    snare.playLoop(1)
    kick.playLoop(2.5)
    snare.playLoop(3)
    kick.playLoop(4)
    snare.playLoop(5)
    kick.playLoop(6.5)
    snare.playLoop(7)
  })

  // kickButton.click(kick.playOnce) 
  // snareButton.click(snare.playOnce)
  // hatButton.click(hat.playOnce)


  // Not in use
  // function bindDrumToEvent(event, drums, options) {
  //   drums.map(function(drum) {
  //     if (event.which === options[drum.name]) {
  //       drum.play()
  //     }
  //   })
  // }

  $(document).keydown(handleToggleSamples)
  $(document).keyup(handleToggleSamples)

  function toggleSample(isKeydown, sample) {
    if (isKeydown) {
      sample.play()
    } else {
      sample.stop()
    }
  }

  function handleToggleSamples(e) {
    console.log(e)
    // TRUE or FALSE
    var isKeydown = e.type === "keydown"

    if (e.which == 55 || e.which == 36){
      toggleSample(isKeydown, kick)
      kickButton.toggleClass('active');
    }

    if (e.which == 56 || e.which == 38){
      toggleSample(isKeydown, snare)
      snareButton.toggleClass('active');
    }

    if (e.which == 57 || e.which == 33){
      toggleSample(isKeydown, hat)
      hatButton.toggleClass('active');
    }

    if (e.which == 52 || e.which == 37){
      toggleSample(isKeydown, wooden)
      woodenButton.toggleClass('active');
    }

    if (e.which == 53 || e.which == 12){
      toggleSample(isKeydown, metal)
      metalButton.toggleClass('active');
    }

    if (e.which == 54 || e.which == 39){
      toggleSample(isKeydown, snare1)
      snare1Button.toggleClass('active');
    }

    if (e.which == 54 || e.which == 35){
      toggleSample(isKeydown, ride)
      rideButton.toggleClass('active');
    }

    if (e.which == 54 || e.which == 40){
      toggleSample(isKeydown, lead)
      leadButton.toggleClass('active');
    }

    if (e.which == 54 || e.which == 45){
      toggleSample(isKeydown, bass)
      bassButton.toggleClass('active');
    }
  }



  // $(document).keydown(function(e){
  //   console.log(e);
  //   if (e.which == 55 || e.which == 36){
  //     kick.play();
  //     kickButton.addClass('active');
  //   }

  //   if (e.which == 56 || e.which == 38){
  //     snare.play();
  //     snareButton.addClass('active');
  //   }

  //   if (e.which == 57 || e.which == 33){
  //     hat.play();
  //     hatButton.addClass('active');
  //   }

  //   if (e.which == 54){
  //     wooden.play()
  //     woodenButton.addClass('active');
  //   }

  //   if (e.which == 53){
  //     metal.play()
  //     metalButton.addClass('active');
  //   }

  //   if (e.which == 52){
  //     snare1.play()
  //     snare1Button.addClass('active');
  //   }
  // });


  // $(document).keyup(function(e){
  //   if (e.which == 55 || e.which == 36){
  //     kick.stop()
  //     kickButton.removeClass('active');
  //   }

  //   if (e.which == 56 || e.which == 38){
  //     snare.stop()
  //     snareButton.removeClass('active');
  //   }

  //   if (e.which == 57 || e.which == 33){
  //     hat.stop()
  //     hatButton.removeClass('active');
  //   }

  //   if (e.which == 54){
  //     wooden.stop()
  //     woodenButton.removeClass('active');
  //   }

  //   if (e.which == 53){
  //     metal.stop()
  //     metalButton.removeClass('active');
  //   }

  //   if (e.which == 52){
  //     snare1.stop()
  //     snare1Button.removeClass('active');
  //   }
  // });

})()

  
</script>
</body>
</html>