<html>
<head>
	<title>web audio api</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <style>
    body {
      background: #222;
    }
    button { 
      width: 8rem;
      height: 8rem;
      background: #666;
      border: 2px solid black;
      color: #ddd;
      font-size: 2rem;
    }
  </style>
</head>
<body>


<button class="play">kick</button>
<button class="stop">snare</button>
<button class="hat">hat</button>

<!-- <input class="playback-rate-control" type="range" min="0.25" max="3" step="0.05" value="1"></span>
<span class="playback-rate-value">1</span>
</br>
<span class="loopstart-control">loop start control</span>
<span class="loopstart-value"></span>
</br>
<span class="loopend-control">loop end control</span>
<span class="loopend-value"></span> -->



<pre></pre>

<script>
// define variables

var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
var source;
// var songLength;

var pre = document.querySelector('pre');
var myScript = document.querySelector('script');
var play = document.querySelector('.play');
var stop = document.querySelector('.stop');
// var hat = document.querySelector('.hat');

// var playbackControl = document.querySelector('.playback-rate-control');
// var playbackValue = document.querySelector('.playback-rate-value');
// playbackControl.setAttribute('disabled', 'disabled');

// var loopstartControl = document.querySelector('.loopstart-control');
// var loopstartValue = document.querySelector('.loopstart-value');
// loopstartControl.setAttribute('disabled', 'disabled');

// var loopendControl = document.querySelector('.loopend-control');
// var loopendValue = document.querySelector('.loopend-value');
// loopendControl.setAttribute('disabled', 'disabled');

// use XHR to load an audio track, and
// decodeAudioData to decode it and stick it in a buffer.
// Then we put the buffer into the source


(function() {
  var kickSample = undefined

  var pre = document.querySelector('pre');
  var myScript = document.querySelector('script');
  var play = document.querySelector('.play');
  var stop = document.querySelector('.stop');

  var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  Sample = function(filename) {
    var request = new XMLHttpRequest();
    request.open('GET', filename, true);
    request.responseType = 'arraybuffer';
    var sampleBuffer = undefined
    var isPlaying = false

    this.drumName = filename.split(".")[0]
    this.loop = false
    
    request.onload = function() {
      var audioData = request.response; 

      audioCtx.decodeAudioData(
        audioData, 
        function(buffer) {
          sampleBuffer = buffer;
        }, 
        function(e){"Error with decoding audio data" + e.err}
      );
    }
    request.send();
 
    this.play = function() {
      if (isPlaying === false) {
        var sample = audioCtx.createBufferSource()
        sample.buffer = sampleBuffer;
        sample.connect(audioCtx.destination);
        sample.loop = this.loop;
        sample.start(0)
      }
      
      isPlaying = true
    }

    this.stop = function() {
      isPlaying = false
    }
  }

  var kick = new Sample("kick.wav")
  var snare = new Sample("snare.wav")
  var hat = new Sample("hat.wav")
  // hat = new Sample("hat.wav")

  play.onclick = kick.play
  stop.onclick = snare.play
  hat.onclick = hat.play

  // Not in use
  function bindDrumToEvent(event, drums, options) {
    drums.map(function(drum) {
      if (event.which === options[drum.name]) {
        drum.play()
      }
    })
  }

  $(document).keydown(function(e){
    // key 7
    if (e.which == 5579){
      kick.play()
    }

    if (e.which == 56){
      snare.play()
    }

    if (e.which == 57){
      hat.play()
    }
  });

  $(document).keyup(function(e){
    if (e.which == 55){
      console.log("7 keypress")
      kick.stop()
    }

    if (e.which == 56){
      snare.stop()
    }

    if (e.which == 57){
      hat.play()
    }
  });

})()



// function getHat() {
//   source = audioCtx.createBufferSource();
//   request = new XMLHttpRequest();
//   request.open('GET', 'hat.wav', true);
//   request.responseType = 'arraybuffer';


//   request.onload = function() {
//     var audioData = request.response;

//     audioCtx.decodeAudioData(audioData, function(buffer) {
//         myBuffer = buffer;
//         // songLength = buffer.duration;
//         source.buffer = myBuffer;
//         // source.playbackRate.value = playbackControl.value;
//         source.connect(audioCtx.destination);
//         source.loop = false;

//         // loopstartControl.setAttribute('max', Math.floor(songLength));
//         // loopendControl.setAttribute('max', Math.floor(songLength));
//       },

//       function(e){"Error with decoding audio data" + e.err});
//   }
//   request.send();
// }

// wire up buttons to stop and play audio, and range slider control

  // play.removeAttribute('disabled');
  // playbackControl.setAttribute('disabled', 'disabled');
  // loopstartControl.setAttribute('disabled', 'disabled');
  // loopendControl.setAttribute('disabled', 'disabled');


// hat.onclick = function() {
//   getHat();
//   source.start(0);
// }


// playbackControl.oninput = function() {
//   source.playbackRate.value = playbackControl.value;
//   playbackValue.innerHTML = playbackControl.value;
// }

// loopstartControl.oninput = function() {
//   source.loopStart = loopstartControl.value;
//   loopstartValue.innerHTML = loopstartControl.value;
// }

// loopendControl.oninput = function() {
//   source.loopEnd = loopendControl.value;
//   loopendValue.innerHTML = loopendControl.value;
// }


  
</script>
</body>
</html>